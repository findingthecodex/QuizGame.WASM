@page "/quiz/oopadvanced/vecka3"

@* <div style="text-align:center;"> *@
@*     <h1>Nya fr√•gor p√• v√§g</h1> *@
@* </div> *@

<div style="
     min-height: 90vh;  
     display: flex;  
     flex-direction: column;  
     align-items: center; 
     padding-top: 1rem;"> 

    <!-- Topic -->
    <MudText Typo="Typo.h1" Align="Align.Center" Class="mb-4">
        OOP Advanced Vecka 3
    </MudText>

    <!-- Show Result -->
    <MudText Typo="Typo.h2" Align="Align.Center" Class="mb-4">
        @(currentQuestion + 1)/10
    </MudText>

    @if (showResult)
    {
        <MudCard Class="p-6" Style="max-width:500px; text-align:center; background-color: transparent">
            <MudText Typo="Typo.h2">üéâ Quiz Completed!</MudText>
            <MudText Typo="Typo.h3">
                Score: @score / 10
            </MudText>

            <MudButton Class="mt-4" OnClick="RestartQuiz">
                Play Again
            </MudButton>
        </MudCard>
    }
    else
    {
        <!-- H√§r ligger ditt nuvarande quiz -->


    <!-- The Question -->
    <MudCard Class="p-4" Style="max-width:600px; margin: 1.5rem auto; text-align: center; background-color:transparent">

        <!-- Question -->
        <MudText Typo="Typo.h2" Class="mb-1">
            @questions[currentQuestion].Question
        </MudText>

        @if (!string.IsNullOrWhiteSpace(questions[currentQuestion].CodeSnippet))
        {
            <MudText Typo="Typo.subtitle2" Class="mt-2 mb-1" Color="Color.Info">
                Exempel:
            </MudText>

            <MudPaper Class="pa-3 mb-3"
                      Elevation="4"
                      Style="
        background:#020617;
        color:#e5e7eb;
        font-family: 'JetBrains Mono', monospace;
        font-size:0.9rem;
        text-align:left;
        border-radius:12px;
        overflow-x:auto;
        max-width:600px;
      ">

                <pre class="code-block">@((MarkupString)System.Net.WebUtility.HtmlEncode(questions[currentQuestion].CodeSnippet ?? ""))</pre>

            </MudPaper>
        }

        <!-- Info under question -->
        <MudText Typo="Typo.subtitle2"
                 Class="mb-3"
                 Style="
            font-weight:600;
            color:#00bfff;
            text-shadow:
              0 0 6px rgba(0,150,255,0.8),
              0 0 12px rgba(0,120,255,0.6),
              0 0 20px rgba(0,90,255,0.4);
         ">

            @(
            questions[currentQuestion].IsTextAnswer
                ? "Skriv ditt svar"
                : questions[currentQuestion].IsMultiChoice
                    ? "V√§lj alla som st√§mmer"
                    : "V√§lj ett svar"
            )

        </MudText>

        <!-- Answer choices / Text answer -->
        @if (questions[currentQuestion].IsTextAnswer)
        {
            <MudTextField
                @bind-Value="textAnswer"
                Placeholder="Skriv h√§r (1‚Äì3 meningar)"
                Variant="Variant.Filled"
                Lines="3"
                Class="mt-3"
                Style="width: 100%; max-width:600px;" />
        }
        else
        {
            <MudGrid Justify="Justify.Center" Spacing="2">

                @for (int i = 0; i < questions[currentQuestion].Answers.Count; i++)
                {
                    var answer = questions[currentQuestion].Answers[i];

                    <MudItem xs="6" class="d-flex justify-center" @key="answer">

                        <MudButton
                            Variant="Variant.Filled"
                            Color="Color.Primary"
                            Class="@GetButtonClass(answer)"
                            OnClick="@(() => SelectAnswer(answer))"
                            Disabled="@answered"
                            Style="
                        width: 220px;
                        height: 70px;
                        font-size: 1rem;
                        font-weight: 600;
                        border-radius: 16px;
                    ">

                            @answer

                        </MudButton>

                    </MudItem>
                }

            </MudGrid>
        }

        @if (questions[currentQuestion].IsMultiChoice || questions[currentQuestion].IsTextAnswer)
        {
            <MudButton
                Class="mt-4 submit-glow"
                Variant="Variant.Filled"
                Color="Color.Inherit"
                disableElevation="true"
                Disabled="@(answered ||
                          (questions[currentQuestion].IsMultiChoice && selectedAnswers.Count == 0) ||
                          (questions[currentQuestion].IsTextAnswer && string.IsNullOrWhiteSpace(textAnswer)))"
                OnClick="SubmitAnswer">

                Submit Answer
            </MudButton>
        }

        <!-- Correct or Wrong text -->
        @if (answered)
        {
            <MudText Typo="Typo.h2" Class="mt-3" Color="@feedbackColor">
                @feedbackMessage
            </MudText>

            <!-- Next Question button -->
            <MudButton
                Class="mt-3"
                Variant="Variant.Filled"
                Color="Color.Primary"
                OnClick="NextQuestion"
                Style="
                        width: 180px;
                        height: 50px;
                        font-size: 1rem;
                        font-weight: 700;
                        border-radius: 20px;
                        box-shadow: 0 0 15px rgba(0,0,0,0.7);
                ">
                Next Question
            </MudButton>
        }



    </MudCard>

    <MudText Typo="Typo.subtitle1" Class="mt-4">
        Score: @score
    </MudText>
    }

</div>

<!-- Copyright l√§ngst ner -->
<div style="
    margin-top: auto;
    padding-bottom: 16px;
    width: 100%;
    display: flex;
    justify-content: center;
    text-align: center;">

    <MudText Typo="Typo.caption" Color="Color.Secondary">
        ¬© 2026 FindingTheCode. All rights reserved.
    </MudText>
</div>

@code {

    string textAnswer = "";

    HashSet<string> selectedAnswers = new(StringComparer.OrdinalIgnoreCase);

    int totalQuestions = 10;
    bool showResult = false;

    int currentQuestion = 0;
    int score = 0;
    bool answered = false;

    string feedbackMessage = "";
    Color feedbackColor = Color.Default;

    protected override void OnInitialized()
    {
        ShuffleQuestions();
    }

    /// <summary>
    ///  Shuffles Questions and answer buttons - multi answers
    /// </summary>
    // csharp
    void ShuffleQuestions()
    {
        var rnd = new Random();

        questions = questions
            .OrderBy(q => rnd.Next())
            .Select(q => new QuizQuestion
            {
                Question = q.Question,
                // Preserve single-answer field
                CorrectAnswer = q.CorrectAnswer,
                // Preserve multi-answer list; if missing but single-correct exists, normalize into list
                CorrectAnswers = (q.CorrectAnswers != null && q.CorrectAnswers.Count > 0)
                    ? q.CorrectAnswers.ToList()
                    : (!string.IsNullOrWhiteSpace(q.CorrectAnswer) ? new List<string> { q.CorrectAnswer } : new List<string>()),
                // Shuffle choices
                Answers = q.Answers?.OrderBy(a => rnd.Next()).ToList() ?? new List<string>(),
                // Preserve text/multi flags and keywords
                IsTextAnswer = q.IsTextAnswer,
                // Preserve code snippet so it shows after shuffle
                CodeSnippet = q.CodeSnippet,
                Keywords = q.Keywords?.ToList() ?? new List<string>()
            })
            .Take(totalQuestions)
            .ToList();
    }


    List<QuizQuestion> questions = new()
    {

    new QuizQuestion
{
    Question = "Livscykel ‚Äì var placerar du f√∂rsta asynkrona datah√§mtningen om den inte beror p√• [Parameter]?",
    Answers = new()
    {
        "Konstruktorn",
        "OnInitializedAsync()",
        "OnParametersSetAsync()",
        "OnAfterRenderAsync()",
        "Dispose()"
    },
    CorrectAnswers = new()
    {
        "OnInitializedAsync()"
    }
},

new QuizQuestion
{
    Question = "Livscykel ‚Äì n√§r ska du anv√§nda OnParametersSetAsync()?",
    Answers = new()
    {
        "N√§r DOM m√•ste finnas",
        "N√§r [Parameter]-v√§rden √§ndras av f√∂r√§ldern",
        "F√∂r tung DI-init i konstruktorn",
        "F√∂r att trigga JS-interop",
        "Aldrig ‚Äì metoden √§r f√∂r√•ldrad"
    },
    CorrectAnswers = new()
    {
        "N√§r [Parameter]-v√§rden √§ndras av f√∂r√§ldern"
    }
},

new QuizQuestion
{
    Question = "Child ‚Üí Parent ‚Äì vilka p√•st√•enden om EventCallback / EventCallback<T> st√§mmer?",
    Answers = new()
    {
        "St√∂der async och b√∂r await-as",
        "√Ñr att f√∂redra framf√∂r Action/Func f√∂r barn‚Üíf√∂r√§lder",
        "Kr√§ver JS-interop",
        "EventCallback<T> ger typs√§kerhet",
        "Fungerar endast i Blazor WASM"
    },
    CorrectAnswers = new()
    {
        "St√∂der async och b√∂r await-as",
        "√Ñr att f√∂redra framf√∂r Action/Func f√∂r barn‚Üíf√∂r√§lder",
        "EventCallback<T> ger typs√§kerhet"
    }
},

new QuizQuestion
{
    Question = "Delat state ‚Äì vilka delar ing√•r i ett robust DI-baserat state-container-m√∂nster?",
    Answers = new()
    {
        "Scoped tj√§nst i DI som √§ger state",
        "StateChanged-event som komponenter prenumererar p√•",
        "Komponenter muterar varandras f√§lt direkt",
        "Prenumerera i OnInitialized och avregistrera i Dispose",
        "Global statisk variabel"
    },
    CorrectAnswers = new()
    {
        "Scoped tj√§nst i DI som √§ger state",
        "StateChanged-event som komponenter prenumererar p√•",
        "Prenumerera i OnInitialized och avregistrera i Dispose"
    }
},

new QuizQuestion
{
    Question = "Identity-light och UI-gating ‚Äì vilka p√•st√•enden st√§mmer?",
    Answers = new()
    {
        "401 = inte inloggad (visa banner eller login-fl√∂de)",
        "403 = inloggad men saknar r√§tt (disable/d√∂lj √•tg√§rd)",
        "UI-gating ers√§tter API-skydd",
        "Owner-OR-Admin √§r ett exempel p√• UI-gating",
        "401 ska visas som f√§ltfel i formul√§r"
    },
    CorrectAnswers = new()
    {
        "401 = inte inloggad (visa banner eller login-fl√∂de)",
        "403 = inloggad men saknar r√§tt (disable/d√∂lj √•tg√§rd)",
        "Owner-OR-Admin √§r ett exempel p√• UI-gating"
    }
},

    // Del B
    new QuizQuestion
    {
        Question = "Komponentmodell ‚Äì vad beskriver b√§st den mentala modellen f√∂r en Blazor-komponent?",
        Answers = new()
        {
            "En kombination av markup och C# som h√•ller state och hanterar events",
            "State √§ndras via events och livscykelmetoder",
            "StateHasChanged triggar render",
            "Komponenten manipulerar DOM direkt",
            "Render sker endast vid sidladdning"
        },
        CorrectAnswers = new()
        {
            "En kombination av markup och C# som h√•ller state och hanterar events",
            "State √§ndras via events och livscykelmetoder",
            "StateHasChanged triggar render"
        }
    },

    new QuizQuestion
    {
        Question = "Datafl√∂de ‚Äì varf√∂r √§r enkelriktat Parent ‚Üí Child-fl√∂de viktigt i Blazor?",
        Answers = new()
        {
            "G√∂r applikationen mer f√∂ruts√§gbar",
            "F√∂renklar fels√∂kning",
            "Minskar sidoeffekter",
            "Till√•ter barnet att √§ndra f√∂r√§lderns state direkt",
            "Kr√§ver JS-interop"
        },
        CorrectAnswers = new()
        {
            "G√∂r applikationen mer f√∂ruts√§gbar",
            "F√∂renklar fels√∂kning",
            "Minskar sidoeffekter"
        }
    },

    new QuizQuestion
    {
        Question = "S√§kerhet i UI ‚Äì vad inneb√§r UI-gating?",
        Answers = new()
        {
            "Att visa/d√∂lja funktioner baserat p√• beh√∂righet",
            "Att ers√§tta API-s√§kerhet",
            "Att skydda resurser i backend",
            "Att endast lita p√• frontend",
            "Att styra synlighet med roller/√§garskap"
        },
        CorrectAnswers = new()
        {
            "Att visa/d√∂lja funktioner baserat p√• beh√∂righet",
            "Att skydda resurser i backend",
            "Att styra synlighet med roller/√§garskap"
        }
    },
    
    // Del C
    new QuizQuestion
    {
        Question = "Child ‚Üí Parent ‚Äì vilken kod anv√§nder EventCallback<string> korrekt?",
        Answers = new()
        {
            @"
[Parameter]
public EventCallback<string> OnSend { get; set; }

await OnSend.InvokeAsync(""Hello"");
",

            @"
[Parameter]
public Action<string> OnSend { get; set; }
",

            @"
public EventCallback<string> OnSend;

OnSend(""Hello"");
",

            @"
OnSend.Invoke(""Hello"");
",

            @"
JS.Invoke(""send"");
"
        },
        CorrectAnswers = new()
        {
            @"
[Parameter]
public EventCallback<string> OnSend { get; set; }

await OnSend.InvokeAsync(""Hello"");
"
        }
    },

    new QuizQuestion
    {
        Question = "UI-gating ‚Äì vilken kod disable:ar Delete korrekt om anv√§ndaren inte √§r Owner eller Admin?",
        Answers = new()
        {
            "<button disabled=\"@(!IsOwner && !IsAdmin)\">Delete</button>",
            "<button disabled=\"@(IsOwner || IsAdmin)\">Delete</button>",
            "<button hidden=\"@(!IsOwner)\">Delete</button>",
            "<button disabled=\"false\">Delete</button>",
            "<button>Delete</button>"
        },
        CorrectAnswers = new()
        {
            "<button disabled=\"@(!IsOwner && !IsAdmin)\">Delete</button>"
        }
    },


    };


    void SelectAnswer(string answer)
    {
        if (answered)
            return;

        var question = questions[currentQuestion];

        if (!question.IsMultiChoice)
        {
            // SINGLE choice ‚Üí v√§lj + r√§tta direkt
            selectedAnswers.Clear();
            selectedAnswers.Add(answer);

            SubmitAnswer();
            return;
        }

        // MULTI choice ‚Üí toggle
        if (selectedAnswers.Contains(answer))
            selectedAnswers.Remove(answer);
        else
            selectedAnswers.Add(answer);

        StateHasChanged();
    }

    void NextQuestion()
    {
        answered = false;
        feedbackMessage = "";
        selectedAnswers.Clear();
        textAnswer = "";

        if (currentQuestion < questions.Count - 1)
            currentQuestion++;
        else
            showResult = true;
    }

    void RestartQuiz()
    {
        currentQuestion = 0;
        score = 0;
        showResult = false;
        ShuffleQuestions();
    }

    string GetButtonClass(string answer)
    {
        if (!answered)
            return selectedAnswers.Contains(answer) ? "glow-button glow-preselect" : "glow-button";

        // after submission
        var correct = GetCorrectSet(questions[currentQuestion]);

        if (correct.Contains(answer))
            return "glow-button glow-selected"; // correct

        if (selectedAnswers.Contains(answer) && !correct.Contains(answer))
            return "glow-button glow-wrong"; // wrongly selected

        return "glow-button";
    }

    void SubmitAnswer()
    {
        answered = true;

        var question = questions[currentQuestion];

        // TEXT ANSWER
        if (question.IsTextAnswer)
        {
            var input = textAnswer?.ToLowerInvariant() ?? "";

            int hits = question.Keywords?.Count(k => input.Contains((k ?? "").ToLowerInvariant())) ?? 0;

            bool isCorrect = hits >= 2; // minst 2 keywords

            if (isCorrect)
            {
                score++;
                feedbackMessage = "Bra svar! ‚úÖ";
                feedbackColor = Color.Success;
            }
            else
            {
                feedbackMessage = "F√∂r kort / saknar viktiga begrepp ‚ùå";
                feedbackColor = Color.Error;
            }

            return;
        }

        // MULTI / SINGLE choice logic - normalize correct answers
        var correctSet = GetCorrectSet(question);

        bool isCorrectMulti =
            selectedAnswers.Count == correctSet.Count &&
            selectedAnswers.All(a => correctSet.Contains(a));

        if (isCorrectMulti)
        {
            score++;
            feedbackMessage = "Correct! üéâ";
            feedbackColor = Color.Success;
        }
        else
        {
            var correctText = string.Join(", ", correctSet);

            feedbackMessage = $"Wrong üò¢ Correct: {correctText}";
            feedbackColor = Color.Error;
        }
    }

    HashSet<string> GetCorrectSet(QuizQuestion q)
    {
        var set = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (q == null)
            return set;

        if (q.CorrectAnswers != null && q.CorrectAnswers.Count > 0)
        {
            foreach (var a in q.CorrectAnswers)
                set.Add(a);
        }
        else if (!string.IsNullOrWhiteSpace(q.CorrectAnswer))
        {
            set.Add(q.CorrectAnswer);
        }

        return set;
    }
}
